Bonjour,

Voici le script SQL corrigé pour votre base de données. Veuillez exécuter ce script dans l'éditeur SQL de Supabase pour résoudre les problèmes du tableau de bord.

Ce script met simplement à jour les fonctions existantes avec une version corrigée qui résout l'erreur de "colonne ambiguë".

---------------------------------------------------------------------
### Instructions
---------------------------------------------------------------------

1.  Allez à l'éditeur SQL dans votre projet Supabase.
2.  Créez une nouvelle requête ("+ New query").
3.  Copiez TOUT le code ci-dessous et collez-le dans l'éditeur.
4.  Cliquez sur "RUN".

---------------------------------------------------------------------
### Code SQL Corrigé à Exécuter
---------------------------------------------------------------------

-- /sql/db_functions.sql
-- This file contains the necessary SQL functions for the admin dashboard.
-- Please apply this file to your Supabase database.

-- Function to get sales by month
CREATE OR REPLACE FUNCTION get_sales_by_month()
RETURNS TABLE(month TEXT, total_sales NUMERIC) AS $$
BEGIN
    RETURN QUERY
    SELECT
        to_char(date_trunc('month', date_creation), 'YYYY-MM') AS month,
        SUM(montant_total) AS total_sales
    FROM commandes
    WHERE statut_paiement IN ('PAYE_EN_LIGNE', 'PAYE_PRESENTIEL')
    GROUP BY date_trunc('month', date_creation)
    ORDER BY date_trunc('month', date_creation);
END;
$$ LANGUAGE plpgsql;

-- Function to get payment method distribution
CREATE OR REPLACE FUNCTION get_payment_method_distribution()
RETURNS TABLE(methode_paiement TEXT, count BIGINT) AS $$
BEGIN
    RETURN QUERY
    SELECT
        commandes.methode_paiement,
        COUNT(*) AS count
    FROM commandes
    GROUP BY commandes.methode_paiement;
END;
$$ LANGUAGE plpgsql;

-- Function to get order status distribution
CREATE OR REPLACE FUNCTION get_order_status_distribution()
RETURNS TABLE(statut_paiement TEXT, count BIGINT) AS $$
BEGIN
    RETURN QUERY
    SELECT
        statut_paiement,
        COUNT(*) AS count
    FROM commandes
    GROUP BY statut_paiement;
END;
$$ LANGUAGE plpgsql;
